<!-- mintABI.js is still loaded just above this -->
<script>
/* =========================================================
   Global handles
========================================================= */
let myWallet   = null;      // active EOA
let myContract = null;      // web3 Contract instance

/* =========================================================
   Run once after the DOM is ready
========================================================= */
window.addEventListener('DOMContentLoaded', () => {
  checkWallet();                 // fire immediately
});

/* =========================================================
   Wallet-connection workflow
========================================================= */
async function checkWallet () {
  /* 0. MetaMask present? */
  if (!window.ethereum) {
    document.getElementById('walletStatus').textContent =
      '❌ MetaMask not detected.';
    return;
  }

  try {
    /* 1. Do we already have permission? */
    let accounts = await ethereum.request({ method: 'eth_accounts' });

    /* 2. If not, ask for it (⚠️ NO params) */
    if (accounts.length === 0) {
      accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    }

    /* 3. Save & show */
    myWallet = accounts[0] || null;
    updateWalletUI();

    /* 4. Set up the contract only after we have an account */
    if (myWallet) contractConnect();

    /* 5. Auto-refresh if the user switches accounts */
    ethereum.removeAllListeners('accountsChanged');   // avoid duplicates
    ethereum.on('accountsChanged', checkWallet);

  } catch (err) {
    console.error('MetaMask error:', err);
    document.getElementById('walletStatus').textContent =
      '❌ Wallet connection failed (see console).';
    document.getElementById('walletButton').hidden = false;
  }
}

/* =========================================================
   Update the little status block
========================================================= */
function updateWalletUI () {
  const status = document.getElementById('walletStatus');
  const btn    = document.getElementById('walletButton');

  if (!myWallet) {
    status.textContent = 'Click to connect your crypto wallet.';
    status.className   = 'text-red-500 mb-2';
    btn.hidden         = false;
  } else {
    status.textContent =
      `✅ Wallet connected: ${myWallet.slice(0, 6)}…${myWallet.slice(-4)}`;
    status.className   = 'text-green-600 mb-2';
    btn.hidden         = true;
  }
}

/* =========================================================
   Instantiate the ERC-20 contract via web3.js
========================================================= */
function contractConnect () {
  const web3 = new Web3(window.ethereum);
  myContract = new web3.eth.Contract(mintABI, mintContractAddress);
}

/* =========================================================
   Mint button
========================================================= */
async function mintTokens () {
  const val = document.getElementById('tokenAmount').value;
  if (!val || val <= 0) {
    alert('Please enter a number greater than zero.'); return;
  }

  const amt = BigInt(val) * 10n ** 18n;   // convert to 18-decimals (uses BigInt)

  myContract.methods.mintFunction(amt.toString()).send({ from: myWallet })
    .then(()   => document.getElementById('responseMessage').textContent =
                 '✅ Tokens successfully minted!')
    .catch(err => {
      console.error(err);
      document.getElementById('responseMessage').textContent =
        '❌ Error: ' + err.message;
    });
}
</script>
